

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Splitting Large Datasets &mdash; OpenDroneMap 0.4 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="OpenDroneMap 0.4 documentation" href="index.html"/>
        <link rel="next" title="Code Reference" href="api.html"/>
        <link rel="prev" title="Dataset Structure" href="dataset.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> OpenDroneMap
          

          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="download.html">Download</a><ul>
<li class="toctree-l2"><a class="reference internal" href="download.html#stable">Stable</a></li>
<li class="toctree-l2"><a class="reference internal" href="download.html#development">Development</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="building.html">Building</a><ul>
<li class="toctree-l2"><a class="reference internal" href="building.html#hardware-recommendations">Hardware Recommendations</a></li>
<li class="toctree-l2"><a class="reference internal" href="building.html#docker-installation-cross-platform">Docker Installation (cross-platform)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="building.html#build-the-image">Build the image</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="building.html#native-installation-ubuntu-16-04">Native Installation (Ubuntu 16.04)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="building.html#setting-environment-variables">Setting environment variables</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="using.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="using.html#docker">Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#native">Native</a><ul>
<li class="toctree-l3"><a class="reference internal" href="using.html#additional-arguments">Additional Arguments</a></li>
<li class="toctree-l3"><a class="reference internal" href="using.html#ground-control-points">Ground Control Points</a></li>
<li class="toctree-l3"><a class="reference internal" href="using.html#video-reconstruction-experimental">Video Reconstruction (Experimental)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="using.html#building-with-slam-support">Building with SLAM support</a></li>
<li class="toctree-l4"><a class="reference internal" href="using.html#calibrating-the-camera">Calibrating the camera</a></li>
<li class="toctree-l4"><a class="reference internal" href="using.html#running-opendronemap-from-a-video">Running OpenDroneMap from a video</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="using.html#camera-calibration">Camera Calibration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="using.html#installation">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="using.html#usage-calibrate-chessboard">Usage: Calibrate chessboard</a></li>
<li class="toctree-l3"><a class="reference internal" href="using.html#usage-undistort-photos">Usage: undistort photos</a></li>
<li class="toctree-l3"><a class="reference internal" href="using.html#docker-usage-for-undistorting-images">Docker Usage for undistorting images</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dataset.html">Dataset Structure</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dataset.html#outputs">Outputs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="dataset.html#d-models-unreferenced">3D Models (unreferenced)</a></li>
<li class="toctree-l3"><a class="reference internal" href="dataset.html#textured-models">Textured Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="dataset.html#georeferencing">Georeferencing</a></li>
<li class="toctree-l3"><a class="reference internal" href="dataset.html#orthophoto">Orthophoto</a></li>
<li class="toctree-l3"><a class="reference internal" href="dataset.html#dem-dsm">DEM/DSM</a></li>
<li class="toctree-l3"><a class="reference internal" href="dataset.html#d-meshing-reconstruction">2.5D Meshing Reconstruction</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Splitting Large Datasets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#calibrate-images">Calibrate images</a></li>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup-py">setup.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-matching-py">run_matching.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#split-py">split.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-reconstructions-py">run_reconstructions.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#align-py">align.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-dense-py">run_dense.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#merge-py">merge.py</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#next-steps">Next steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Code Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="flying.html">Flying tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">How to contribute</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#community-forum">Community Forum</a></li>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#reporting-bugs">Reporting Bugs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#template-for-submitting-bug-reports">Template For Submitting Bug Reports</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#pull-requests">Pull Requests</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">OpenDroneMap</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Splitting Large Datasets</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/large.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="splitting-large-datasets">
<h1>Splitting Large Datasets<a class="headerlink" href="#splitting-large-datasets" title="Permalink to this headline">¶</a></h1>
<p>A recent ODM update (coined split-merge) introduces a new workflow for splitting up very large datasets into manageable chunks (called submodels), running the pipeline on each chunk, and then producing some merged products.</p>
<p>Why might you use the split-merge pipeline? If you have a very large number of images in your dataset, split-merge will help make the processing more manageable on a large machine. It will also alleviate the need for Ground Control. GPS information gathered from the UAV is still a long way from being accurate, and those problems only get more noticeable as datasets scale. Obviously the best results will come from survey-grade GCPs, but this is not always possible.</p>
<p>What split-merge doesn’t solve is the ability to run large datasets on small machines. We have made strides towards reducing processing costs in general, but the goal of split-merge was specifically to solve a scaling problem, not necessarily an efficiency one.</p>
<div class="section" id="calibrate-images">
<h2>Calibrate images<a class="headerlink" href="#calibrate-images" title="Permalink to this headline">¶</a></h2>
<p>Image calibration is essential for large datasets because error propagation due to image distortion will cause a bowl effect on the models. Calibration instructions can be found at <a class="reference internal" href="using.html#calibration"><span class="std std-ref">Calibrating the camera</span></a>.</p>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The scripts lay inside the <code class="docutils literal notranslate"><span class="pre">scripts/metadataset</span></code> folder. They are::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run_all</span><span class="o">.</span><span class="n">sh</span>
<span class="n">setup</span><span class="o">.</span><span class="n">py</span>
<span class="n">run_matching</span><span class="o">.</span><span class="n">py</span>
<span class="n">split</span><span class="o">.</span><span class="n">py</span>
<span class="n">run_reconstructions</span><span class="o">.</span><span class="n">py</span>
<span class="n">align</span><span class="o">.</span><span class="n">py</span>
<span class="n">run_dense</span><span class="o">.</span><span class="n">py</span>
<span class="n">merge</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>If you look into <code class="docutils literal notranslate"><span class="pre">run_all.sh</span></code> you will see that you run each of these scripts in the order above. It’s really just a placeholder file we used for testing, so I will largely ignore it. Instead I will go through each step in order to explain what it does and how to run it.
Before you run the following scripts, you should set up the environment variables::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>RUNPATH=&lt;Set this to your ODM base directory, eg. /home/dmb2/opendronemap&gt;
export PYTHONPATH=$RUNPATH:$RUNPATH/SuperBuild/install/lib/python2.7/dist-packages:$RUNPATH/SuperBuild/src/opensfm:$PYTHONPATH
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$RUNPATH/SuperBuild/install/lib
</pre></div>
</div>
<p>And make sure you have all the parameters you want to pass in the settings.yaml file in the software root directory. You won’t be able to put most of those settings into the command line.</p>
<div class="section" id="setup-py">
<h3>setup.py<a class="headerlink" href="#setup-py" title="Permalink to this headline">¶</a></h3>
<p>This script sets up the metadataset/submodel structure. It takes some arguments::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">path</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">project</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">resize</span><span class="o">-</span><span class="n">to</span> <span class="n">n</span>
<span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">num</span><span class="o">-</span><span class="n">features</span> <span class="n">n</span>
<span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">cores</span> <span class="n">n</span>
<span class="o">--</span><span class="n">matcher</span><span class="o">-</span><span class="n">neighbors</span> <span class="n">n</span>
<span class="o">--</span><span class="n">submodel</span><span class="o">-</span><span class="n">size</span> <span class="n">n</span>
<span class="o">--</span><span class="n">submodel</span><span class="o">-</span><span class="n">overlap</span> <span class="nb">float</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&lt;path-to-project&gt;</span></code> is where the data lies, set up like an ODM project (images should be in an “images” subdirectory), <cite>n</cite> in each of the other parameters is an integer. See <a class="reference external" href="https://github.com/OpenDroneMap/OpenDroneMap/wiki/Run-Time-Parameters">https://github.com/OpenDroneMap/OpenDroneMap/wiki/Run-Time-Parameters</a> for more info on the first four. The submodel-size parameter sets how many images are put in each submodel cluster on average. The default is 80 images. It is good to keep the size small because it decreases the bowling effect overall. There also needs to be sufficient overlap between clusters for alignment and merging the models. The submodel-overlap parameter determines how large a radius (in meters) around the cluster to include neighboring images.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="o">~/</span><span class="n">ODMProjects</span><span class="o">/</span><span class="n">split</span><span class="o">-</span><span class="n">merge</span><span class="o">-</span><span class="n">test</span><span class="o">/</span>
</pre></div>
</div>
</div>
<div class="section" id="run-matching-py">
<h3>run_matching.py<a class="headerlink" href="#run-matching-py" title="Permalink to this headline">¶</a></h3>
<p>Before we split the dataset up, we have to match the images so that the software knows where to make the splits. This is done on the whole dataset, so it can take a while if there are a lot of photos.
This one takes nothing except the project path::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">run_matching</span><span class="o">.</span><span class="n">py</span> <span class="o">~/</span><span class="n">ODMProjects</span><span class="o">/</span><span class="n">split</span><span class="o">-</span><span class="n">merge</span><span class="o">-</span><span class="n">test</span><span class="o">/</span>
</pre></div>
</div>
</div>
<div class="section" id="split-py">
<h3>split.py<a class="headerlink" href="#split-py" title="Permalink to this headline">¶</a></h3>
<p>Now we split the model. This will create a directory called “submodels” within which is a set of directories for each submodel. Each of these is set up like a typical ODM project folder, except the images are symlinked to the root images folder. This is an important concept to know because moving the project folder will break the symlinks if you are not careful.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">split</span><span class="o">.</span><span class="n">py</span> <span class="o">~/</span><span class="n">ODMProjects</span><span class="o">/</span><span class="n">split</span><span class="o">-</span><span class="n">merge</span><span class="o">-</span><span class="n">test</span><span class="o">/</span>
</pre></div>
</div>
</div>
<div class="section" id="run-reconstructions-py">
<h3>run_reconstructions.py<a class="headerlink" href="#run-reconstructions-py" title="Permalink to this headline">¶</a></h3>
<p>Now that we have the submodels, we can run the sparse reconstruction on each. There is an optional argument in this script to run matching on each submodel. You already should have run matching above so we don’t need to do it again.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">run</span><span class="o">-</span><span class="n">matching</span>
</pre></div>
</div>
<p>Here’s what I ran::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">run_reconstructions</span><span class="o">.</span><span class="n">py</span> <span class="o">~/</span><span class="n">ODMProjects</span><span class="o">/</span><span class="n">split</span><span class="o">-</span><span class="n">merge</span><span class="o">-</span><span class="n">test</span><span class="o">/</span>
</pre></div>
</div>
</div>
<div class="section" id="align-py">
<h3>align.py<a class="headerlink" href="#align-py" title="Permalink to this headline">¶</a></h3>
<p>Each submodel is self-referenced, so it’s important to realign the point clouds before getting to the next steps of the pipeline::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">align</span><span class="o">.</span><span class="n">py</span> <span class="o">~/</span><span class="n">ODMProjects</span><span class="o">/</span><span class="n">split</span><span class="o">-</span><span class="n">merge</span><span class="o">-</span><span class="n">test</span><span class="o">/</span>
</pre></div>
</div>
</div>
<div class="section" id="run-dense-py">
<h3>run_dense.py<a class="headerlink" href="#run-dense-py" title="Permalink to this headline">¶</a></h3>
<p>This is the one that will take a while. It basically runs the rest of the toolchain for each aligned submodel.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">run_dense</span><span class="o">.</span><span class="n">py</span> <span class="o">~/</span><span class="n">ODMProjects</span><span class="o">/</span><span class="n">split</span><span class="o">-</span><span class="n">merge</span><span class="o">-</span><span class="n">test</span><span class="o">/</span>
</pre></div>
</div>
<p>And then we wait….</p>
</div>
<div class="section" id="merge-py">
<h3>merge.py<a class="headerlink" href="#merge-py" title="Permalink to this headline">¶</a></h3>
<p>The previous script generated an orthophoto for each submodel, and now we have to merge them into a single file. By default it will not overwrite the resulting TIFF so if you need to rerun, make sure you append <code class="docutils literal notranslate"><span class="pre">--overwrite</span></code>.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">merge</span><span class="o">.</span><span class="n">py</span> <span class="o">~/</span><span class="n">ODMProjects</span><span class="o">/</span><span class="n">split</span><span class="o">-</span><span class="n">merge</span><span class="o">-</span><span class="n">test</span><span class="o">/</span> <span class="o">--</span><span class="n">overwrite</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<p>This process is a pretty great start to scaling our image processing capabilities, although there is always work to be done. Overall, I would like to see the process streamlined into the standard OpenDroneMap flow. I would also like to see more merged outputs than only the GeoTIFF: the point cloud, textured mesh, and DSM/DTM for starters. Huge props to Pau and the folks at Mapillary for their amazing contributions to OpenDroneMap through their OpenSfM code. I look forward to further pushing the limits of OpenDroneMap and seeing how big a dataset we can process.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="api.html" class="btn btn-neutral float-right" title="Code Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="dataset.html" class="btn btn-neutral" title="Dataset Structure" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, OpenDroneMap.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.4',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>